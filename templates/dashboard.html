<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis AI-IDS Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { gray: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' } } }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 border-r border-gray-700 bg-gray-900 p-6 hidden md:block">
        <div class="flex items-center gap-3 mb-10">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i data-lucide="shield-check"></i>
            </div>
            <h1 class="text-xl font-bold text-white">Aegis IDS</h1>
        </div>
        <nav class="flex flex-col gap-2">
            <div class="flex items-center gap-3 rounded-lg bg-blue-600 px-4 py-3 text-white font-medium">
                <i data-lucide="layout-dashboard"></i>
                <span>Dashboard</span>
            </div>
            <div class="flex items-center gap-3 rounded-lg px-4 py-3 text-gray-400 hover:bg-gray-800 transition">
                <i data-lucide="file-text"></i>
                <span>Logs</span>
            </div>
        </nav>
        
        <div class="mt-auto card p-4">
            <h4 class="font-semibold text-white">System Status</h4>
            <div class="flex items-center gap-2 text-sm font-medium text-green-400 mt-2">
                <span class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                AI Engine Online
            </div>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-auto">
        <header class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-white">Live Monitoring</h2>
            <button class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 text-white relative">
                <i data-lucide="bell"></i>
                <span class="absolute top-0 right-0 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-400">Total Threats</p>
                    <span id="kpi-threats" class="text-3xl font-bold text-white">0</span>
                </div>
                <div class="p-3 rounded-full bg-red-500/20 text-red-400">
                    <i data-lucide="alert-triangle"></i>
                </div>
            </div>
            <div class="card p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-400">Critical Anomalies</p>
                    <span id="kpi-anomalies" class="text-3xl font-bold text-white">0</span>
                </div>
                <div class="p-3 rounded-full bg-orange-500/20 text-orange-400">
                    <i data-lucide="zap"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card lg:col-span-2 p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Traffic Analysis</h3>
                <div class="h-64">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Attack Vectors</h3>
                <div class="h-64">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card overflow-hidden">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">Live Alert Log</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-800 text-gray-400 text-sm uppercase">
                        <tr>
                            <th class="p-4">Timestamp</th>
                            <th class="p-4">Severity</th>
                            <th class="p-4">Method</th>
                            <th class="p-4">Source IP</th>
                            <th class="p-4">Destination IP</th>
                        </tr>
                    </thead>
                    <tbody id="alert-table-body" class="text-sm text-gray-300 divide-y divide-gray-700">
                        <tr>
                            <td class="p-4 text-center" colspan="5">Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // 1. Initialize Icons
        lucide.createIcons();

        // 2. Initialize Charts
        const ctxMain = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctxMain, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Threats Detected',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#334155' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
        });

        const ctxPie = document.getElementById('pieChart').getContext('2d');
        const pieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#ef4444', '#f97316', '#eab308', '#3b82f6'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
        });

        // 3. Fetch Live Data
        async function fetchMetrics() {
            try {
                const response = await fetch('/api/metrics');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                // Update KPI Numbers
                document.getElementById('kpi-threats').innerText = data.total_threats;
                document.getElementById('kpi-anomalies').innerText = data.anomalies_24h;

                // Update Table
                const tbody = document.getElementById('alert-table-body');
                if(data.recent_alerts.length > 0) {
                    tbody.innerHTML = ''; // Clear "Waiting..." text
                    data.recent_alerts.slice().reverse().forEach(alert => {
                        // Color coding for severity
                        let badgeColor = 'bg-blue-900 text-blue-300';
                        if(alert.Severity.includes('High')) badgeColor = 'bg-red-900 text-red-300';
                        if(alert.Severity.includes('Medium')) badgeColor = 'bg-yellow-900 text-yellow-300';

                        const row = `
                            <tr class="hover:bg-gray-800 transition">
                                <td class="p-4">${alert.Time}</td>
                                <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeColor}">${alert.Severity}</span></td>
                                <td class="p-4 font-mono text-white">${alert.Method}</td>
                                <td class="p-4 text-gray-400">${alert.Source}</td>
                                <td class="p-4 text-gray-400">${alert.Destination}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                }

                // Update Charts (Simple logic: Add count to graph)
                // In a real app, you'd track time buckets. Here we just show the growing total.
                const now = new Date().toLocaleTimeString();
                if (mainChart.data.labels.length > 10) {
                    mainChart.data.labels.shift();
                    mainChart.data.datasets[0].data.shift();
                }
                mainChart.data.labels.push(now);
                mainChart.data.datasets[0].data.push(data.total_threats);
                mainChart.update();

                // Update Pie Chart
                pieChart.data.labels = Object.keys(data.category_counts);
                pieChart.data.datasets[0].data = Object.values(data.category_counts);
                pieChart.update();

            } catch (error) {
                console.error("Error fetching metrics:", error);
            }
        }

        // Refresh every 2 seconds
        setInterval(fetchMetrics, 2000);
        fetchMetrics();
    </script>
</body>
</html>